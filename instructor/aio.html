<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="it" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>HPC Workflow Management with Snakemake: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="../favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      HPC Workflow Management with Snakemake
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            HPC Workflow Management with Snakemake
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  HPC Workflow Management with Snakemake
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Esecuzione di comandi con Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-snakemake_on_the_cluster.html">2. Esecuzione di Snakemake sul cluster</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-placeholders.html">3. Segnaposto</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-snakemake_and_mpi.html">4. Applicazioni MPI e Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-chaining_rules.html">5. Concatenazione di regole</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-expansion.html">6. Elaborazione di elenchi di input</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Esecuzione di comandi con Snakemake</a></p>
<hr>
<p>Last updated on 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/01-introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 60 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Come si esegue un semplice comando con Snakemake?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Creare una ricetta di Snakemake (uno Snakefile)”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="qual-è-il-flusso-di-lavoro-che-mi-interessa">Qual è il flusso di lavoro che mi interessa?<a class="anchor" aria-label="anchor" href="#qual-%C3%A8-il-flusso-di-lavoro-che-mi-interessa"></a>
</h2>
<hr class="half-width">
<p>In questa lezione faremo un esperimento che prende un’applicazione
che gira in parallelo e ne studia la scalabilità. Per farlo dovremo
raccogliere dati, in questo caso significa eseguire l’applicazione più
volte con un numero diverso di core della CPU e registrare il tempo di
esecuzione. Una volta fatto questo, dobbiamo creare una visualizzazione
dei dati per vedere come si confronta con il caso ideale.</p>
<p>Dalla visualizzazione possiamo decidere a quale scala ha più senso
eseguire l’applicazione in produzione per massimizzare l’uso della CPU
allocata nel sistema.</p>
<p>Potremmo fare tutto questo manualmente, ma ci sono strumenti utili
per aiutarci a gestire le pipeline di analisi dei dati come quelle del
nostro esperimento. Oggi ne conosceremo uno: Snakemake.</p>
<p>Per iniziare a usare Snakemake, iniziamo con un semplice comando e
vediamo come eseguirlo tramite Snakemake. Scegliamo il comando
<code>hostname</code> che stampa il nome dell’host in cui viene eseguito
il comando:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">node1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
<p>Questo stampa il risultato, ma Snakemake si affida ai file per
conoscere lo stato del flusso di lavoro, quindi reindirizziamo l’output
a un file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname <span class="op">&gt;</span> hostname_login.txt</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="creazione-di-un-file-snake">Creazione di un file Snake<a class="anchor" aria-label="anchor" href="#creazione-di-un-file-snake"></a>
</h2>
<hr class="half-width">
<p>Modificare un nuovo file di testo chiamato
<code>Snakefile</code>.</p>
<p>Contenuto di <code>Snakefile</code>:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule hostname_login:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"hostname_login.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:  </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    shell:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_login.txt"</span></span></code></pre>
</div>
<div id="punti-chiave-di-questo-file" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="punti-chiave-di-questo-file" class="callout-inner">
<h3 class="callout-title">Punti chiave di questo file</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>Il file si chiama <code>Snakefile</code> - con la maiuscola
<code>S</code> e senza estensione.</li>
<li>Alcune righe sono rientrate. I rientri devono essere fatti con
caratteri di spazio, non con tabulazioni. Si veda la sezione di
impostazione per sapere come far sì che il proprio editor di testo
faccia questo.</li>
<li>La definizione della regola inizia con la parola chiave
<code>rule</code> seguita dal nome della regola, poi da due punti.</li>
<li>Abbiamo chiamato la regola <code>hostname_login</code>. Si possono
usare lettere, numeri o trattini bassi, ma il nome della regola deve
iniziare con una lettera e non può essere una parola chiave.</li>
<li>Le parole chiave <code>input</code>, <code>output</code> e
<code>shell</code> sono tutte seguite da due punti (“:”).</li>
<li>I nomi dei file e il comando di shell sono tutti in
<code>"quotes"</code>.</li>
<li>Il nome del file di output viene dato prima del nome del file di
input. In realtà, a Snakemake non interessa l’ordine in cui appaiono, ma
in questo corso daremo prima l’output. Vedremo presto perché.</li>
<li>In questo caso d’uso non c’è un file di input per il comando, quindi
lo lasciamo vuoto.</li>
</ol>
</div>
</div>
</div>
<p>Torniamo alla shell ed eseguiamo la nostra nuova regola. A questo
punto, se ci sono virgolette mancanti, rientri errati e così via,
potremmo vedere un errore.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-j1</span> <span class="at">-p</span> hostname_login</span></code></pre>
</div>
<div id="bash-snakemake-command-not-found..." class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="bash-snakemake-command-not-found..." class="callout-inner">
<h3 class="callout-title"><code>bash: snakemake: command not found...</code></h3>
<div class="callout-content">
<p>Se la shell vi dice che non riesce a trovare il comando
<code>snakemake</code>, allora dobbiamo rendere il software disponibile
in qualche modo. Nel nostro caso, ciò significa cercare il modulo che
dobbiamo caricare:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">module</span> spider snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[ocaisa@node1 ~]$ module spider snakemake

--------------------------------------------------------------------------------------------------------
  snakemake:
--------------------------------------------------------------------------------------------------------
     Versions:
        snakemake/8.2.1-foss-2023a
        snakemake/8.2.1 (E)

Names marked by a trailing (E) are extensions provided by another module.


--------------------------------------------------------------------------------------------------------
  For detailed information about a specific "snakemake" package (including how to load the modules) use the module's full name.
  Note that names that have a trailing (E) are extensions provided by other modules.
  For example:

     $ module spider snakemake/8.2.1
--------------------------------------------------------------------------------------------------------</code></pre>
</div>
<p>Ora vogliamo il modulo, quindi carichiamolo per rendere disponibile
il pacchetto</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load snakemake</span></code></pre>
</div>
<p>e poi assicurarsi di avere a disposizione il comando
<code>snakemake</code></p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ which snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/cvmfs/software.eessi.io/host_injections/2023.06/software/linux/x86_64/amd/zen3/software/snakemake/8.2.1-foss-2023a/bin/snakemake</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-j1</span> <span class="at">-p</span> hostname_login</span></code></pre>
</div>
</div>
</div>
</div>
<div id="esecuzione-di-snakemake" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="esecuzione-di-snakemake" class="callout-inner">
<h3 class="callout-title">Esecuzione di Snakemake</h3>
<div class="callout-content">
<p>Eseguire <code>snakemake --help | less</code> per vedere la guida per
tutte le opzioni disponibili. Che cosa fa l’opzione <code>-p</code> nel
comando <code>snakemake</code> di cui sopra?</p>
<ol style="list-style-type: decimal">
<li>protegge i file di output esistenti</li>
<li>stampa i comandi di shell che vengono eseguiti sul terminale</li>
<li>Indica a Snakemake di eseguire solo un processo alla volta</li>
<li>chiede all’utente il file di input corretto</li>
</ol>
</div>
</div>
</div>
<div id="accordionHint1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button hint-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHint1" aria-expanded="false" aria-controls="collapseHint1">
  <h4 class="accordion-header" id="headingHint1"> Give me a hint </h4>
</button>
<div id="collapseHint1" class="accordion-collapse collapse" aria-labelledby="headingHint1" data-bs-parent="#accordionHint1">
<div class="accordion-body">
<p>È possibile cercare nel testo premendo <kbd>/</kbd>, e tornare alla
shell con <kbd>q</kbd>.</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<ol start="2" style="list-style-type: decimal">
<li>Stampa i comandi di shell che vengono eseguiti sul terminale</li>
</ol>
<p>Questa è una cosa così utile che non sappiamo perché non sia
l’opzione predefinita! L’opzione <code>-j1</code> indica a Snakemake di
eseguire solo un processo alla volta, e per ora ci atterremo a questa
opzione perché rende le cose più semplici. La risposta 4 è un’assurdità,
poiché Snakemake non richiede mai un input interattivo da parte
dell’utente.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Prima di eseguire Snakemake è necessario scrivere uno
Snakefile”</li>
<li>“Uno Snakefile è un file di testo che definisce un elenco di
regole”</li>
<li>“Le regole hanno ingressi, uscite e comandi di shell da
eseguire”</li>
<li>“Si dice a Snakemake quale file creare e questo esegue il comando di
shell definito nella regola appropriata”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-02-snakemake_on_the_cluster"><p>Content from <a href="02-snakemake_on_the_cluster.html">Esecuzione di Snakemake sul cluster</a></p>
<hr>
<p>Last updated on 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/02-snakemake_on_the_cluster.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 50 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Come si esegue la mia regola di Snakemake nel cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Definire le regole da eseguire localmente e sul cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Cosa succede quando vogliamo che la nostra regola venga eseguita sul
cluster piuttosto che sul nodo di accesso? Il cluster che stiamo usando
usa Slurm e si dà il caso che Snakemake abbia un supporto integrato per
Slurm, dobbiamo solo dirgli che vogliamo usarlo.</p>
<p>Snakemake utilizza l’opzione <code>executor</code> per consentire di
selezionare il plugin che si desidera eseguire la regola. Il modo più
rapido per applicarlo al proprio file Snake è definirlo sulla riga di
comando. Proviamo</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_login</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Nothing to be done (all requested files are present and up to date).</code></pre>
</div>
<p>Non è successo nulla! Perché no? Quando gli viene chiesto di
costruire un target, Snakemake controlla il “tempo di ultima modifica”
del target e delle sue dipendenze. Se una dipendenza è stata aggiornata
dopo il target, le azioni vengono rieseguite per aggiornare il target.
Utilizzando questo approccio, Snakemake sa che deve ricostruire solo i
file che, direttamente o indirettamente, dipendono dal file che è stato
modificato. Questo è chiamato <em>costruzione incrementale</em>.</p>
<div id="le-build-incrementali-migliorano-lefficienza" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="le-build-incrementali-migliorano-lefficienza" class="callout-inner">
<h3 class="callout-title">Le build incrementali migliorano l’efficienza</h3>
<div class="callout-content">
<p>Ricostruendo i file solo quando necessario, Snakemake rende
l’elaborazione più efficiente.</p>
</div>
</div>
</div>
<div id="in-esecuzione-sul-cluster" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="in-esecuzione-sul-cluster" class="callout-inner">
<h3 class="callout-title">In esecuzione sul cluster</h3>
<div class="callout-content">
<p>Ora abbiamo bisogno di un’altra regola che esegua la
<code>hostname</code> sul <em>cluster</em>. Creare una nuova regola nel
file Snake e provare a eseguirla sul cluster con le opzioni da
<code>--executor slurm</code> a <code>snakemake</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>La regola è quasi identica alla regola precedente, tranne che per il
nome della regola e il file di output:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>Si può quindi eseguire la regola con</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_remote</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 1
Job stats:
job                count
---------------  -------
hostname_remote        1
total                  1

Select jobs to execute...
Execute 1 jobs...

[Mon Jan 29 18:03:46 2024]
rule hostname_remote:
    output: hostname_remote.txt
    jobid: 0
    reason: Missing output files: hostname_remote.txt
    resources: tmpdir=&lt;TBD&gt;

hostname &gt; hostname_remote.txt
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
No wall time information given. This might or might not work on your cluster.
If not, specify the resource runtime in your rule or as a reasonable default
via --default-resources. No job memory information ('mem_mb' or
'mem_mb_per_cpu') is given - submitting without.
This might or might not work on your cluster.
Job 0 has been submitted with SLURM jobid 326 (log: /home/ocaisa/.snakemake/slurm_logs/rule_hostname_remote/326.log).
[Mon Jan 29 18:04:26 2024]
Finished job 0.
1 of 1 steps (100%) done
Complete log: .snakemake/log/2024-01-29T180346.788174.snakemake.log</code></pre>
</div>
<p>Notate tutti gli avvertimenti che Snakemake ci dà sul fatto che la
regola potrebbe non essere in grado di essere eseguita sul nostro
cluster, perché forse non abbiamo fornito informazioni sufficienti.
Fortunatamente per noi, questa regola funziona sul nostro cluster e
possiamo dare un’occhiata al file di output creato dalla nuova regola,
<code>hostname_remote.txt</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ cat hostname_remote.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">tmpnode1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="profilo-di-snakemake">Profilo di Snakemake<a class="anchor" aria-label="anchor" href="#profilo-di-snakemake"></a>
</h2>
<hr class="half-width">
<p>L’adattamento di Snakemake a un particolare ambiente può comportare
molti flag e opzioni. Pertanto, è possibile specificare un profilo di
configurazione da utilizzare per ottenere le opzioni predefinite. Questo
profilo si presenta come</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> myprofileFolder ...</span></code></pre>
</div>
<p>La cartella del profilo deve contenere un file chiamato
<code>config.yaml</code> che è quello che memorizzerà le nostre opzioni.
La cartella può contenere anche altri file necessari per il profilo.
Creiamo il file <code>cluster_profile/config.yaml</code> e inseriamo
alcune delle nostre opzioni esistenti:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span></code></pre>
</div>
<p>Ora dovremmo essere in grado di rilanciare il nostro flusso di lavoro
puntando al profilo invece di elencare le opzioni. Per forzare
l’esecuzione del nostro flusso di lavoro, dobbiamo prima rimuovere il
file di output <code>hostname_remote.txt</code> e poi possiamo provare
il nostro nuovo profilo</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ rm hostname_remote.txt</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile hostname_remote</span></code></pre>
</div>
<p>Il profilo è estremamente utile nel contesto del nostro cluster,
poiché l’esecutore Slurm ha molte opzioni e a volte è necessario usarle
per poter inviare lavori al cluster a cui si ha accesso.
Sfortunatamente, i nomi delle opzioni in Snakemake non sono esattamente
gli stessi di Slurm, quindi abbiamo bisogno dell’aiuto di una tabella di
traduzione:</p>
<table class="table">
<colgroup>
<col width="17%">
<col width="17%">
<col width="64%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>--partition</code></td>
<td><code>slurm_partition</code></td>
<td>the partition a rule/job is to use</td>
</tr>
<tr class="even">
<td><code>--time</code></td>
<td><code>runtime</code></td>
<td>the walltime per job in minutes</td>
</tr>
<tr class="odd">
<td><code>--constraint</code></td>
<td><code>constraint</code></td>
<td>may hold features on some clusters</td>
</tr>
<tr class="even">
<td><code>--mem</code></td>
<td><code>mem, mem_mb</code></td>
<td>memory a cluster node must</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>provide (mem: string with unit), mem_mb: int</td>
</tr>
<tr class="even">
<td><code>--mem-per-cpu</code></td>
<td><code>mem_mb_per_cpu</code></td>
<td>memory per reserved CPU</td>
</tr>
<tr class="odd">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="even">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="odd">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>Le avvertenze fornite da Snakemake suggeriscono che potrebbe essere
necessario fornire queste opzioni. Un modo per farlo è fornirle come
parte della regola di Snakemake usando la parola chiave
<code>resources</code>, ad esempio,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>rule:</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    output: ...</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    resources:</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>        partition <span class="op">=</span> <span class="op">&lt;</span>partition name<span class="op">&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>        runtime <span class="op">=</span> <span class="op">&lt;</span>some number<span class="op">&gt;</span></span></code></pre>
</div>
<p>e possiamo anche usare il profilo per definire valori predefiniti per
queste opzioni da usare con il nostro progetto, usando la parola chiave
<code>default-resources</code>. Ad esempio, la memoria disponibile sul
nostro cluster è di circa 4 GB per core, quindi possiamo aggiungerla al
nostro profilo:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Sappiamo che il nostro problema viene eseguito in un tempo molto
breve. Cambiare la durata predefinita dei nostri lavori a due minuti per
Slurm.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Esistono varie opzioni <code>sbatch</code> non supportate
direttamente dalle definizioni delle risorse nella tabella precedente. È
possibile utilizzare la risorsa <code>slurm_extra</code> per specificare
uno qualsiasi di questi flag aggiuntivi a <code>sbatch</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule myrule:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    output: ...</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    resources:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>        slurm_extra<span class="op">=</span><span class="st">"--mail-type=ALL --mail-user=&lt;your email&gt;"</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="esecuzione-di-regole-locali">Esecuzione di regole locali<a class="anchor" aria-label="anchor" href="#esecuzione-di-regole-locali"></a>
</h2>
<hr class="half-width">
<p>La nostra regola iniziale era di ottenere il nome host del nodo di
accesso. Vogliamo sempre eseguire la regola sul nodo di accesso perché
abbia senso. Se diciamo a Snakemake di eseguire tutte le regole tramite
l’esecutore Slurm (cosa che stiamo facendo tramite il nostro nuovo
profilo), questo non accadrà più. Quindi come si fa a forzare
l’esecuzione della regola sul nodo di login?</p>
<p>Beh, nel caso in cui una regola di Snakemake esegua un compito
banale, l’invio di un lavoro potrebbe essere eccessivo (ad esempio, meno
di un minuto di tempo di calcolo). Come nel nostro caso, sarebbe meglio
che queste regole venissero eseguite localmente (cioè dove viene
eseguito il comando <code>snakemake</code>) invece che come lavoro.
Snakemake consente di indicare quali regole devono essere sempre
eseguite localmente con la parola chiave <code>localrules</code>.
Definiamo <code>hostname_login</code> come regola locale vicino alla
parte superiore del nostro <code>Snakefile</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>localrules: hostname_login</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake genera e invia i propri script batch per lo
scheduler”</li>
<li>“È possibile memorizzare le impostazioni di configurazione
predefinite in un profilo Snakemake”</li>
<li>“<code>localrules</code> definisce le regole che vengono eseguite
localmente e non vengono mai inviate a un cluster”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-03-placeholders"><p>Content from <a href="03-placeholders.html">Segnaposto</a></p>
<hr>
<p>Last updated on 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/03-placeholders.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 70 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Come si crea una regola generica?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Vedere come Snakemake gestisce alcuni errori”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Il nostro Snakefile presenta alcune duplicazioni. Per esempio, i nomi
dei file di testo sono ripetuti in alcuni punti delle regole dello
Snakefile. Gli Snakefile sono una forma di codice e, in qualsiasi
codice, la ripetizione può portare a problemi (ad esempio, rinominiamo
un file di dati in una parte dello Snakefile, ma dimentichiamo di
rinominarlo altrove).</p>
<div id="d.r.y.-dont-repeat-yourself" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="d.r.y.-dont-repeat-yourself" class="callout-inner">
<h3 class="callout-title">D.R.Y. (Don’t Repeat Yourself)</h3>
<div class="callout-content">
<p>In molti linguaggi di programmazione, la maggior parte delle
caratteristiche del linguaggio serve a consentire al programmatore di
descrivere lunghe routine di calcolo come codice breve, espressivo e
bello. Le caratteristiche di Python, R o Java, come le variabili e le
funzioni definite dall’utente, sono utili in parte perché ci evitano di
dover scrivere (o pensare) tutti i dettagli più volte. Questa buona
abitudine di scrivere le cose solo una volta è nota come principio “Non
ripetere te stesso” o D.R.Y.</p>
</div>
</div>
</div>
<p>Rimuoviamo alcune ripetizioni dal nostro Snakefile.</p>
<section><h2 class="section-heading" id="segnaposto">Segnaposto<a class="anchor" aria-label="anchor" href="#segnaposto"></a>
</h2>
<hr class="half-width">
<p>Per creare una regola più generica abbiamo bisogno di
<strong>placeholder</strong>. Vediamo l’aspetto di un segnaposto</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>        <span class="co">"hostname &gt; {output}"</span></span></code></pre>
</div>
<p>Come promemoria, ecco la versione precedente dell’ultimo
episodio:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>La nuova regola ha sostituito i nomi di file espliciti con cose in
<code>{curly brackets}</code>, in particolare <code>{output}</code> (ma
avrebbe potuto essere anche <code>{input}</code>… se avesse avuto un
valore e fosse stato utile).</p>
<div class="section level3">
<h3 id="input-e-output-sono-dei-segnaposto">
<code>{input}</code> e <code>{output}</code> sono <strong>dei
segnaposto</strong>
<a class="anchor" aria-label="anchor" href="#input-e-output-sono-dei-segnaposto"></a>
</h3>
<p>I segnaposto sono usati nella sezione <code>shell</code> di una
regola e Snakemake li sostituisce con valori appropriati -
<code>{input}</code> con il nome completo del file di input e
<code>{output}</code> con il nome completo del file di output - prima di
eseguire il comando.</p>
<p>anche <code>{resources}</code> è un segnaposto e si può accedere a un
elemento nominato di <code>{resources}</code> con la notazione
<code>{resources.runtime}</code> (per esempio).</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Le regole di Snakemake sono rese più generiche con i
segnaposto”</li>
<li>“I segnaposto nella parte shell della regola vengono sostituiti con
valori basati sui caratteri jolly scelti”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-04-snakemake_and_mpi"><p>Content from <a href="04-snakemake_and_mpi.html">Applicazioni MPI e Snakemake</a></p>
<hr>
<p>Last updated on 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-snakemake_and_mpi.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 50 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Come si esegue un’applicazione MPI tramite Snakemake sul
cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Definire le regole da eseguire localmente e sul cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Ora è il momento di tornare al nostro flusso di lavoro reale.
Possiamo eseguire un comando sul cluster, ma che dire dell’esecuzione
dell’applicazione MPI che ci interessa? La nostra applicazione si chiama
<code>amdahl</code> ed è disponibile come modulo d’ambiente.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Individuare e caricare il modulo <code>amdahl</code> e quindi
<em>sostituire</em> la nostra regola <code>hostname_remote</code> con
una versione che esegue <code>amdahl</code>. (Non preoccupatevi ancora
dell’MPI parallelo, ma eseguitelo con una sola CPU,
<code>mpiexec -n 1 amdahl</code>).</p>
<p>La regola viene eseguita correttamente? In caso contrario, cercare
nei file di log per scoprirne il motivo?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">module</span> spider amdahl</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">module</span> load amdahl</span></code></pre>
</div>
<p>individuerà e caricherà il modulo <code>amdahl</code>. Possiamo
quindi aggiornare/sostituire la nostra regola per eseguire
l’applicazione <code>amdahl</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Tuttavia, quando si tenta di eseguire la regola si ottiene un errore
(a meno che non sia già disponibile una versione diversa di
<code>amdahl</code> nel proprio percorso). Snakemake riporta la
posizione dei log e se guardiamo all’interno possiamo (alla fine)
trovare</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>...
mpiexec -n 1 amdahl &gt; amdahl_run.txt
--------------------------------------------------------------------------
mpiexec was unable to find the specified executable file, and therefore
did not launch the job.  This error was first reported for process
rank 0; it may have occurred for other processes as well.

NOTE: A common cause for this error is misspelling a mpiexec command
      line parameter option (remember that mpiexec interprets the first
      unrecognized command line token as the executable).

Node:       tmpnode1
Executable: amdahl
--------------------------------------------------------------------------
...</code></pre>
</div>
<p>Quindi, anche se abbiamo caricato il modulo prima di eseguire il
flusso di lavoro, la nostra regola Snakemake non ha trovato
l’eseguibile. Questo perché la regola Snakemake viene eseguita in un
ambiente <em>runtime</em> pulito e dobbiamo dirgli in qualche modo di
caricare il modulo ambiente necessario prima di provare a eseguire la
regola.</p>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="snakemake-e-moduli-di-ambiente">Snakemake e moduli di ambiente<a class="anchor" aria-label="anchor" href="#snakemake-e-moduli-di-ambiente"></a>
</h2>
<hr class="half-width">
<p>La nostra applicazione si chiama <code>amdahl</code> ed è disponibile
sul sistema tramite un modulo d’ambiente, quindi dobbiamo dire a
Snakemake di caricare il modulo prima di provare a eseguire la regola.
Snakemake conosce i moduli d’ambiente, che possono essere specificati
tramite (un’altra) opzione:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>      <span class="co">"mpi4py"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    shell:</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>L’aggiunta di queste righe non è tuttavia sufficiente a far eseguire
la regola. Non solo bisogna dire a Snakemake quali moduli caricare, ma
bisogna anche dirgli di usare i moduli d’ambiente in generale (poiché si
ritiene che l’uso dei moduli d’ambiente renda l’ambiente di runtime meno
riproducibile, dato che i moduli disponibili possono differire da
cluster a cluster). Per questo è necessario dare a Snakemake un’opzione
aggiuntiva</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile <span class="at">--use-envmodules</span> amdahl_run</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Utilizzeremo i moduli d’ambiente per tutto il resto del tutorial,
quindi rendiamola un’opzione predefinita del nostro profilo (impostando
il suo valore a <code>True</code>)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Aggiornare il profilo del cluster a</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">use-envmodules</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre>
</div>
<p>Se si vuole testare, è necessario cancellare il file di output della
regola e rieseguire Snakemake.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-e-mpi">Snakemake e MPI<a class="anchor" aria-label="anchor" href="#snakemake-e-mpi"></a>
</h2>
<hr class="half-width">
<p>Nell’ultima sezione non abbiamo eseguito un’applicazione MPI, in
quanto abbiamo eseguito solo su un core. Come si fa a richiedere
l’esecuzione su più core per una singola regola?</p>
<p>Snakemake ha un supporto generale per MPI, ma l’unico esecutore che
attualmente supporta esplicitamente MPI è l’esecutore Slurm (per nostra
fortuna!). Se guardiamo alla nostra tabella di traduzione da Slurm a
Snakemake, notiamo che le opzioni rilevanti appaiono in fondo:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="15%">
<col width="65%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="odd">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="even">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>L’opzione che ci interessa è <code>tasks</code>, poiché aumenteremo
solo il numero di ranghi. Possiamo definirli in una sezione
<code>resources</code> della nostra regola e fare riferimento ad essi
usando dei segnaposto:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    resources:</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">'mpiexec'</span>,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    shell:</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Questo ha funzionato, ma ora abbiamo un piccolo problema. Vogliamo
farlo per alcuni valori diversi di <code>tasks</code>, il che significa
che abbiamo bisogno di un file di output diverso per ogni esecuzione.
Sarebbe fantastico se potessimo indicare in qualche modo nel file
<code>output</code> il valore che vogliamo usare per <code>tasks</code>…
e far sì che Snakemake lo prenda.</p>
<p>Potremmo usare un <em>wildcard</em> nel <code>output</code> per
permetterci di definire il <code>tasks</code> che vogliamo usare. La
sintassi di questo carattere jolly è la seguente</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span></code></pre>
</div>
<p>dove <code>parallel_tasks</code> è il nostro carattere jolly.</p>
<div id="caratteri-jolly" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="caratteri-jolly" class="callout-inner">
<h3 class="callout-title">Caratteri jolly</h3>
<div class="callout-content">
<p>I caratteri jolly sono usati nelle righe <code>input</code> e
<code>output</code> della regola per rappresentare parti di nomi di
file. Come lo schema <code>*</code> nella shell, il carattere jolly può
sostituire qualsiasi testo per comporre il nome del file desiderato.
Come per la denominazione delle regole, si può scegliere un nome a
piacere per i caratteri jolly, qui abbiamo usato
<code>parallel_tasks</code>. L’uso degli stessi caratteri jolly
nell’input e nell’output indica a Snakemake come abbinare i file di
input a quelli di output.</p>
<p>Se due regole utilizzano un carattere jolly con lo stesso nome,
Snakemake le tratterà come entità diverse - le regole in Snakemake sono
autocontenute in questo modo.</p>
<p>Nella riga <code>shell</code> si può fare riferimento al carattere
jolly con <code>{wildcards.parallel_tasks}</code></p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="ordine-delle-operazioni-di-snakemake">Ordine delle operazioni di Snakemake<a class="anchor" aria-label="anchor" href="#ordine-delle-operazioni-di-snakemake"></a>
</h2>
<hr class="half-width">
<p>Abbiamo appena iniziato con alcune semplici regole, ma vale la pena
di pensare a cosa fa esattamente Snakemake quando lo si esegue. Ci sono
tre fasi distinte:</p>
<ol style="list-style-type: decimal">
<li>Prepara l’esecuzione:
<ol style="list-style-type: decimal">
<li>Legge tutte le definizioni delle regole dal file Snakefile</li>
</ol>
</li>
<li>Pianifica cosa fare:
<ol style="list-style-type: decimal">
<li>vede quale/i file si sta chiedendo di creare</li>
<li>Cerca una regola corrispondente guardando le <code>output</code> di
tutte le regole che conosce</li>
<li>Compila i caratteri jolly per ottenere il valore <code>input</code>
per questa regola</li>
<li>verifica che questo file di input (se richiesto) sia effettivamente
disponibile</li>
</ol>
</li>
<li>Esegue i passi:
<ol style="list-style-type: decimal">
<li>Crea la directory per il file di output, se necessario</li>
<li>Rimuove il vecchio file di output, se è già presente</li>
<li>Solo allora, esegue il comando di shell con i segnaposto
sostituiti</li>
<li>controlla che il comando sia stato eseguito senza errori <em>e</em>
che il nuovo file di output sia stato creato come previsto</li>
</ol>
</li>
</ol>
<div id="modalità-di-esecuzione-a-secco--n" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="modalità-di-esecuzione-a-secco--n" class="callout-inner">
<h3 class="callout-title">Modalità di esecuzione a secco
(<code>-n</code>)</h3>
<div class="callout-content">
<p>Spesso è utile eseguire solo le prime due fasi, in modo che Snakemake
pianifichi i lavori da eseguire e li stampi sullo schermo, ma non li
esegua mai. Questo viene fatto con il flag <code>-n</code>, ad
esempio:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="op">&gt;</span> $ <span class="ex">snakemake</span> <span class="at">-n</span> ...</span></code></pre>
</div>
</div>
</div>
</div>
<p>La quantità di controlli può sembrare pedante in questo momento, ma
con l’aumentare dei passi del flusso di lavoro questo diventerà davvero
molto utile.</p>
</section><section><h2 class="section-heading" id="usando-i-caratteri-jolly-nella-nostra-regola">Usando i caratteri jolly nella nostra regola<a class="anchor" aria-label="anchor" href="#usando-i-caratteri-jolly-nella-nostra-regola"></a>
</h2>
<hr class="half-width">
<p>Vorremmo usare un carattere jolly nel <code>output</code> per
permetterci di definire il numero di <code>tasks</code> che vogliamo
usare. Sulla base di quanto visto finora, si potrebbe immaginare che
questo potrebbe essere simile a</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    resources:</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="st">"</span><span class="sc">{parallel_tasks}</span><span class="st">"</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    shell:</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>ma ci sono due problemi:</p>
<ul>
<li>L’unico modo per Snakemake di conoscere il valore del carattere
jolly è che l’utente richieda esplicitamente un file di output concreto
(invece di chiamare la regola):</li>
</ul>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>  <span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile amdahl_run_2.txt</span></code></pre>
</div>
<p>questo è perfettamente valido, poiché Snakemake è in grado di capire
che ha una regola che può corrispondere a quel nome di file.</p>
<ul>
<li>
<p>Il problema maggiore è che anche così non funziona, sembra che
non si possa usare un carattere jolly per <code>tasks</code>:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>WorkflowError:
SLURM job submission failed. The error message was sbatch:
error: Invalid numeric value "{parallel_tasks}" for --ntasks.</code></pre>
</div>
</li>
</ul>
<p>Purtroppo per noi, non c’è un modo diretto per accedere ai caratteri
jolly per <code>tasks</code>. Il motivo è che Snakemake cerca di usare
il valore di <code>tasks</code> durante la fase di inizializzazione,
quindi prima di conoscere il valore del carattere jolly. È necessario
rimandare la determinazione di <code>tasks</code> a un momento
successivo. Questo si può ottenere specificando una funzione di input
invece di un valore per questo scenario. La soluzione è quindi quella di
scrivere una funzione da usare una sola volta per manipolare Snakemake
in modo che lo faccia per noi. Poiché la funzione è specifica per la
regola, possiamo usare una funzione di una riga senza nome. Questo tipo
di funzioni sono chiamate funzioni anonime o funzioni lamdba (entrambe
hanno lo stesso significato) e sono una caratteristica di Python (e di
altri linguaggi di programmazione).</p>
<p>Per definire una funzione lambda in python, la sintassi generale è la
seguente:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">lambda</span> x: x <span class="op">+</span> <span class="dv">54</span></span></code></pre>
</div>
<p>Poiché la nostra funzione può accettare i caratteri jolly come
argomenti, possiamo usarli per impostare il valore di
<code>tasks</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    resources:</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    shell:</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Ora abbiamo una regola che può essere usata per generare output da
esecuzioni di un numero arbitrario di task paralleli.</p>
<div id="commenti-in-snakefiles" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="commenti-in-snakefiles" class="callout-inner">
<h3 class="callout-title">Commenti in Snakefiles</h3>
<div class="callout-content">
<p>Nel codice precedente, la riga che inizia con <code>#</code> è una
riga di commento. Si spera che abbiate già l’abitudine di aggiungere
commenti ai vostri script. Un buon commento rende qualsiasi script più
leggibile, e questo vale anche per Snakefiles.</p>
</div>
</div>
</div>
<p>Poiché la nostra regola è ora in grado di generare un numero
arbitrario di file di output, le cose potrebbero diventare molto
affollate nella nostra directory corrente. Probabilmente è meglio
mettere le esecuzioni in una cartella separata per mantenere l’ordine.
Possiamo aggiungere la cartella direttamente al nostro
<code>output</code> e Snakemake si occuperà della creazione della
directory per noi:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    resources:</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    shell:</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Creare un file di output (sotto la cartella <code>runs</code>) per il
caso in cui si abbiano 6 task paralleli</p>
<p>(SUGGERIMENTO: ricordate che Snakemake deve essere in grado di far
corrispondere il file richiesto al <code>output</code> di una
regola)</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile runs/amdahl_run_6.txt</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Un’altra cosa della nostra applicazione <code>amdahl</code> è che
alla fine vogliamo elaborare l’output per generare il nostro grafico in
scala. L’output in questo momento è utile per la lettura, ma rende più
difficile l’elaborazione. in <code>amdahl</code> c’è un’opzione che ci
facilita questo compito. Per vedere le opzioni di <code>amdahl</code> si
può usare</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load amdahl</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ amdahl <span class="at">--help</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: amdahl [-h] [-p [PARALLEL_PROPORTION]] [-w [WORK_SECONDS]] [-t] [-e]

options:
  -h, --help            show this help message and exit
  -p [PARALLEL_PROPORTION], --parallel-proportion [PARALLEL_PROPORTION]
                        Parallel proportion should be a float between 0 and 1
  -w [WORK_SECONDS], --work-seconds [WORK_SECONDS]
                        Total seconds of workload, should be an integer greater than 0
  -t, --terse           Enable terse output
  -e, --exact           Disable random jitter</code></pre>
</div>
<p>L’opzione che stiamo cercando è <code>--terse</code>, che farà
stampare l’output di <code>amdahl</code> in un formato molto più facile
da elaborare, JSON. Il formato JSON in un file usa tipicamente
l’estensione <code>.json</code>, quindi aggiungiamo questa opzione al
nostro comando <code>shell</code> e cambiamo il formato del file
<code>output</code> per adattarlo al nostro nuovo comando:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    resources:</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    shell:</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse &gt; {output}"</span></span></code></pre>
</div>
<p>C’era un altro parametro per <code>amdahl</code> che ha attirato la
mia attenzione. <code>amdahl</code> ha un’opzione
<code>--parallel-proportion</code> (o <code>-p</code>) che potremmo
essere interessati a cambiare perché modifica il comportamento del
codice e quindi ha un impatto sui valori che otteniamo nei nostri
risultati. Aggiungiamo un altro livello di directory al nostro formato
di output per riflettere una scelta particolare per questo valore.
Possiamo usare un carattere jolly in modo da non dover scegliere subito
il valore:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    resources:</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    shell:</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse -p {wildcards.parallel_proportion} &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Crea un file di output per un valore di <code>-p</code> di 0,999 (il
valore predefinito è 0,8) per il caso in cui abbiamo 6 task
paralleli.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake sceglie la regola appropriata sostituendo i caratteri
jolly in modo che l’output corrisponda all’obiettivo”</li>
<li>“Snakemake controlla varie condizioni di errore e si ferma se vede
un problema”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-05-chaining_rules"><p>Content from <a href="05-chaining_rules.html">Concatenazione di regole</a></p>
<hr>
<p>Last updated on 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/05-chaining_rules.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 70 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Come si combinano le regole in un flusso di lavoro?”</li>
<li>“Come faccio a creare una regola con più ingressi e uscite?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="una-pipeline-di-regole-multiple">Una pipeline di regole multiple<a class="anchor" aria-label="anchor" href="#una-pipeline-di-regole-multiple"></a>
</h2>
<hr class="half-width">
<p>Ora abbiamo una regola che può generare output per qualsiasi valore
di <code>-p</code> e per qualsiasi numero di task, dobbiamo solo
chiamare Snakemake con i parametri che vogliamo:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
<p>Questo però non è esattamente comodo, per generare un set di dati
completo dobbiamo eseguire Snakemake molte volte con diversi target di
file di output. Creiamo invece una regola che generi questi file per
noi.</p>
<p>Il concatenamento delle regole in Snakemake è una questione di scelta
di modelli di nomi di file che collegano le regole. Si tratta di
un’arte: nella maggior parte dei casi ci sono diverse opzioni che
funzionano:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:  <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_6.json"</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>La nuova regola non fa nulla, si assicura solo che venga creato il
file desiderato. Non vale la pena eseguirla sul cluster. Come
assicurarsi che venga eseguita solo sul nodo di accesso?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Dobbiamo aggiungere la nuova regola alla nostra
<code>localrules</code>:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>localrules: hostname_login, generate_run_files</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Ora eseguiamo la nuova regola (ricordiamo che dobbiamo richiedere il
file di output per nome, poiché il <code>output</code> nella nostra
regola contiene un pattern jolly):</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile/ p_0.999_runs.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Using profile cluster_profile/ for setting default command line arguments.
Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 3
Job stats:
job                   count
------------------  -------
amdahl_run                1
generate_run_files        1
total                     2

Select jobs to execute...
Execute 1 jobs...

[Tue Jan 30 17:39:29 2024]
rule amdahl_run:
    output: p_0.999/runs/amdahl_run_6.json
    jobid: 1
    reason: Missing output files: p_0.999/runs/amdahl_run_6.json
    wildcards: parallel_proportion=0.999, parallel_tasks=6
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954,
               tmpdir=&lt;TBD&gt;, mem_mb_per_cpu=3600, runtime=2, mpi=mpiexec, tasks=6

mpiexec -n 6 amdahl --terse -p 0.999 &gt; p_0.999/runs/amdahl_run_6.json
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
Job 1 has been submitted with SLURM jobid 342 (log: /home/ocaisa/.snakemake/slurm_logs/rule_amdahl_run/342.log).
[Tue Jan 30 17:47:31 2024]
Finished job 1.
1 of 2 steps (50%) done
Select jobs to execute...
Execute 1 jobs...

[Tue Jan 30 17:47:31 2024]
localrule generate_run_files:
    input: p_0.999/runs/amdahl_run_6.json
    output: p_0.999_runs.txt
    jobid: 0
    reason: Missing output files: p_0.999_runs.txt;
            Input files updated by another job: p_0.999/runs/amdahl_run_6.json
    wildcards: parallel_proportion=0.999
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954,
               tmpdir=/tmp, mem_mb_per_cpu=3600, runtime=2

echo p_0.999/runs/amdahl_run_6.json done &gt; p_0.999_runs.txt
[Tue Jan 30 17:47:31 2024]
Finished job 0.
2 of 2 steps (100%) done
Complete log: .snakemake/log/2024-01-30T173929.781106.snakemake.log</code></pre>
</div>
<p>Osservate i messaggi di log che Snakemake stampa nel terminale. Che
cosa è successo?</p>
<ol style="list-style-type: decimal">
<li>Snakemake cerca una regola per creare
<code>p_0.999_runs.txt</code>
</li>
<li>Determina che “generate_run_files” può fare questo se
<code>parallel_proportion=0.999</code>
</li>
<li>Vede che l’input necessario è quindi
<code>p_0.999/runs/amdahl_run_6.json</code>
</li>
<li>Snakemake cerca una regola per creare
<code>p_0.999/runs/amdahl_run_6.json</code>
</li>
<li>Determina che “amdahl_run” può fare questo se
<code>parallel_proportion=0.999</code> e
<code>parallel_tasks=6</code>
</li>
<li>Ora Snakemake ha raggiunto un file di input disponibile (in questo
caso, non è richiesto alcun file di input), esegue entrambi i passaggi
per ottenere l’output finale</li>
</ol>
<p>Questo, in breve, è il modo in cui costruiamo i flussi di lavoro in
Snakemake.</p>
<ol style="list-style-type: decimal">
<li>Definizione delle regole per tutte le fasi di elaborazione</li>
<li>Scegliere modelli di denominazione <code>input</code> e
<code>output</code> che consentano a Snakemake di collegare le
regole</li>
<li>Indica a Snakemake di generare i file di output finali</li>
</ol>
<p>Se si è abituati a scrivere script regolari, ci vuole un po’ di tempo
per abituarsi. Invece di elencare i passi in ordine di esecuzione, si
lavora sempre a ritroso** dal risultato finale desiderato. L’ordine
delle operazioni è determinato dall’applicazione delle regole di
corrispondenza dei pattern ai nomi dei file, non dall’ordine delle
regole nel file Snake.</p>
<div id="prima-le-uscite" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="prima-le-uscite" class="callout-inner">
<h3 class="callout-title">Prima le uscite?</h3>
<div class="callout-content">
<p>L’approccio di Snakemake di lavorare a ritroso partendo dall’output
desiderato per determinare il flusso di lavoro è il motivo per cui
mettiamo le righe <code>output</code> per prime in tutte le nostre
regole - per ricordarci che sono queste le prime cose che Snakemake
guarda!</p>
<p>Molti utenti di Snakemake, e in effetti la documentazione ufficiale,
preferiscono avere il <code>input</code> per primo, quindi in pratica si
dovrebbe usare l’ordine che si ritiene più opportuno.</p>
</div>
</div>
</div>
<div id="uscite-log-in-snakemake" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="uscite-log-in-snakemake" class="callout-inner">
<h3 class="callout-title">Uscite <code>log</code> in Snakemake</h3>
<div class="callout-content">
<p>Snakemake ha un campo di regole dedicato per le uscite che sono <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#log-files" class="external-link">file
di log</a>, e queste sono trattate per lo più come uscite normali,
tranne per il fatto che i file di log non vengono rimossi se il lavoro
produce un errore. Ciò significa che è possibile consultare il log per
diagnosticare l’errore. In un flusso di lavoro reale questo può essere
molto utile, ma in termini di apprendimento dei fondamenti di Snakemake
ci atterremo ai normali campi <code>input</code> e
<code>output</code>.</p>
</div>
</div>
</div>
<div id="gli-errori-sono-normali" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="gli-errori-sono-normali" class="callout-inner">
<h3 class="callout-title">Gli errori sono normali</h3>
<div class="callout-content">
<p>Non scoraggiatevi se vedete degli errori quando testate per la prima
volta le vostre nuove pipeline di Snakemake. Ci sono molte cose che
possono andare storte quando si scrive un nuovo flusso di lavoro e di
solito sono necessarie diverse iterazioni per ottenere le cose giuste.
Un vantaggio dell’approccio di Snakemake rispetto ai normali script è
che Snakemake fallisce rapidamente quando c’è un problema, invece di
continuare e potenzialmente eseguire calcoli inutili su dati parziali o
corrotti. Un altro vantaggio è che quando un passo fallisce si può
riprendere tranquillamente da dove si era interrotto.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake collega le regole cercando iterativamente le regole che
hanno ingressi mancanti”</li>
<li>“Le regole possono avere più ingressi e/o uscite con nome”</li>
<li>“Se un comando di shell non produce l’output previsto, Snakemake lo
considererà un fallimento”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-06-expansion"><p>Content from <a href="06-expansion.html">Elaborazione di elenchi di input</a></p>
<hr>
<p>Last updated on 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/06-expansion.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 80 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Come posso elaborare più file contemporaneamente?”</li>
<li>“Come si combinano più file insieme?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Usare Snakemake per elaborare tutti i campioni in una volta
sola”</li>
<li>“Creare un grafico di scalabilità che riunisca i nostri
risultati”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Abbiamo creato una regola che può generare un singolo file di output,
ma non abbiamo intenzione di creare più regole per ogni file di output.
Vogliamo generare tutti i file di esecuzione con una sola regola, se
possibile, ma Snakemake può accettare un elenco di file di input:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">input</span>:  <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_2.json"</span>, <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_6.json"</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<p>È fantastico, ma non vogliamo dover elencare singolarmente tutti i
file che ci interessano. Come possiamo fare?</p>
<section><h2 class="section-heading" id="definizione-di-un-elenco-di-campioni-da-elaborare">Definizione di un elenco di campioni da elaborare<a class="anchor" aria-label="anchor" href="#definizione-di-un-elenco-di-campioni-da-elaborare"></a>
</h2>
<hr class="half-width">
<p>Per fare questo, possiamo definire alcuni elenchi come
<strong>variabili globali</strong> di Snakemake.</p>
<p>Le variabili globali devono essere aggiunte prima delle regole nel
file Snake.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Task sizes we wish to run</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>NTASK_SIZES <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span></code></pre>
</div>
<ul>
<li>A differenza di quanto avviene con le variabili negli script di
shell, possiamo mettere degli spazi intorno al segno <code>=</code>, ma
non sono obbligatori.</li>
<li>Gli elenchi di stringhe quotate sono racchiusi tra parentesi quadre
e separati da virgole. Se conoscete un po’ di Python, riconoscerete che
si tratta della sintassi delle liste di Python.</li>
<li>Una buona convenzione è quella di usare nomi in maiuscolo per queste
variabili, ma non è obbligatorio.</li>
<li>Sebbene questi elenchi siano definiti variabili, non è possibile
modificare i valori una volta che il flusso di lavoro è in esecuzione,
quindi gli elenchi definiti in questo modo sono più simili a
costanti.</li>
</ul></section><section><h2 class="section-heading" id="utilizzo-di-una-regola-di-snakemake-per-definire-un-gruppo-di-uscite">Utilizzo di una regola di Snakemake per definire un gruppo di
uscite<a class="anchor" aria-label="anchor" href="#utilizzo-di-una-regola-di-snakemake-per-definire-un-gruppo-di-uscite"></a>
</h2>
<hr class="half-width">
<p>Ora aggiorniamo il nostro Snakefile per sfruttare la nuova variabile
globale e creare un elenco di file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<p>La funzione <code>expand(...)</code> di questa regola genera un
elenco di nomi di file, prendendo la prima cosa tra le parentesi singole
come modello e sostituendo <code>{count}</code> con tutti gli
<code>NTASK_SIZES</code>. Poiché ci sono 5 elementi nell’elenco, si
otterranno 5 file che vogliamo creare. Si noti che abbiamo dovuto
proteggere il nostro carattere jolly in una seconda serie di parentesi,
in modo che non venisse interpretato come qualcosa che doveva essere
espanso.</p>
<p>Nel nostro caso attuale ci basiamo ancora sul nome del file per
definire il valore del carattere jolly <code>parallel_proportion</code>,
quindi non possiamo chiamare direttamente la regola, ma dobbiamo
richiedere un file specifico:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.999_runs.txt</span></code></pre>
</div>
<p>Se non si specifica un nome di regola di destinazione o un nome di
file sulla riga di comando quando si esegue Snakemake, l’impostazione
predefinita è di usare <strong>la prima regola</strong> nel file Snake
come destinazione.</p>
<div id="regole-come-target" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="regole-come-target" class="callout-inner">
<h3 class="callout-title">Regole come target</h3>
<div class="callout-content">
<p>Dare il nome di una regola a Snakemake sulla riga di comando funziona
solo se quella regola non ha <em>parole jolly</em> in uscita, perché
Snakemake non ha modo di sapere quali potrebbero essere le parole jolly
desiderate. Verrà visualizzato l’errore “Le regole di destinazione non
possono contenere caratteri jolly” Questo può accadere anche quando non
si fornisce alcun target esplicito sulla riga di comando e Snakemake
cerca di eseguire la prima regola definita nel file Snake.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="regole-che-combinano-più-input">Regole che combinano più input<a class="anchor" aria-label="anchor" href="#regole-che-combinano-pi%C3%B9-input"></a>
</h2>
<hr class="half-width">
<p>La nostra regola <code>generate_run_files</code> è una regola che
accetta un elenco di file di input. La lunghezza di tale elenco non è
fissata dalla regola, ma può cambiare in base a
<code>NTASK_SIZES</code>.</p>
<p>Nel nostro flusso di lavoro il passo finale consiste nel prendere
tutti i file generati e combinarli in una trama. Per fare questo, forse
avete sentito che alcune persone usano una libreria python chiamata
<code>matplotlib</code>. Non è compito di questo tutorial scrivere lo
script python per creare un grafico finale, quindi vi forniremo lo
script come parte di questa lezione. È possibile scaricarlo con</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-O</span> https://ocaisa.github.io/hpc-workflows/files/plot_terse_amdahl_results.py</span></code></pre>
</div>
<p>Lo script <code>plot_terse_amdahl_results.py</code> ha bisogno di una
riga di comando che assomiglia a:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">python</span> plot_terse_amdahl_results.py <span class="at">--output</span> <span class="op">&lt;</span>output image filename<span class="op">&gt;</span> <span class="op">&lt;</span>1st input file<span class="op">&gt;</span> <span class="op">&lt;</span>2nd input file<span class="op">&gt;</span> ...</span></code></pre>
</div>
<p>Introduciamo questa funzione nella nostra regola
<code>generate_run_files</code>:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    shell:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="co">"python plot_terse_amdahl_results.py --output {output} {input}"</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Questo script si basa su <code>matplotlib</code>, è disponibile come
modulo d’ambiente? Aggiungere questo requisito alla regola.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_scalability.jpg"</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>      <span class="co">"matplotlib"</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    shell:</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>        <span class="co">"python plot_terse_amdahl_results.py --output {output} {input}"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Ora finalmente possiamo generare un grafico in scala! Eseguire il
comando finale di Snakemake:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.999_scalability.jpg</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Generare il grafico della scalabilità per tutti i valori da 1 a 10
core.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>NTASK_SIZES <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Eseguire nuovamente il flusso di lavoro per un valore <code>p</code>
di 0,8</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.8_scalability.jpg</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="bonus-round" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="bonus-round" class="callout-inner">
<h3 class="callout-title">Bonus round</h3>
<div class="callout-content">
<p>Creare una regola finale che possa essere richiamata direttamente e
che generi un grafico in scala per 3 diversi valori di
<code>p</code>.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Utilizzare la funzione <code>expand()</code> per generare elenchi
di nomi di file da combinare”</li>
<li>“Ogni <code>{input}</code> a una regola può essere un elenco di
lunghezza variabile”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:maintainers-hpc@lists.carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY-4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "inLanguage": "it",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "HPC Carpentry, snakemake, workflows, hpc",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "identifier": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "dateCreated": "2023-04-19",
  "dateModified": "2025-04-05",
  "datePublished": "2025-04-05"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

