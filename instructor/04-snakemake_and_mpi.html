<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="it" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>HPC Workflow Management with Snakemake: Applicazioni MPI e Snakemake</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Salta al contenuto principale</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://docs.carpentries.org/resources/curriculum/lesson-life-cycle.html" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Cambia tema (automatico)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Vista Istruttore <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../04-snakemake_and_mpi.html';">Vista Studente</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Navigazione Principale"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Attiva/Disattiva Navigazione">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      HPC Workflow Management with Snakemake
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Cerca nella pagina Tutto in Uno" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            HPC Workflow Management with Snakemake
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Punti Chiave</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Note per l'Istruttore</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Estrai Tutte le Immagini</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Altro <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Cerca nella pagina Tutto in Uno"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Cerca nella pagina Tutto in Uno">Cerca nella pagina Tutto in Uno</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  HPC Workflow Management with Snakemake
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 47%" class="percentage">
    47%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 47%" aria-valuenow="47" aria-label="Progresso della Lezione" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="chiudi menu" alt="chiudi menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Nascondi " data-episodes="Episodi ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Vista Istruttore
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../04-snakemake_and_mpi.html">Vista Studente</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODI
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Riepilogo e Programma</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Esecuzione di comandi con Snakemake</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-snakemake_on_the_cluster.html">2. Esecuzione di Snakemake sul cluster</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-placeholders.html">3. Segnaposto</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        4. Applicazioni MPI e Snakemake
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#snakemake-e-moduli-di-ambiente">Snakemake e moduli di ambiente</a></li>
<li><a href="#snakemake-e-mpi">Snakemake e MPI</a></li>
<li><a href="#ordine-delle-operazioni-di-snakemake">Ordine delle operazioni di Snakemake</a></li>
<li><a href="#usando-i-caratteri-jolly-nella-nostra-regola">Usando i caratteri jolly nella nostra regola</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-chaining_rules.html">5. Concatenazione di regole</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-expansion.html">6. Elaborazione di elenchi di input</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RISORSE
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Punti Chiave</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Note per l'Istruttore</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Estrai Tutte le Immagini</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">Visualizza tutto in una pagina</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Capitolo Precedente e Successivo"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/03-placeholders.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Precedente</a>
        <a class="chapter-link float-end" href="../instructor/05-chaining_rules.html">Successivo<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/03-placeholders.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Precedente: Segnaposto
        </a>
        <a class="chapter-link float-end" href="../instructor/05-chaining_rules.html" rel="next">
          Successivo: Concatenazione di...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Applicazioni MPI e Snakemake</h1>
        <p>Ultimo aggiornamento il 2025-04-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-snakemake_and_mpi.md" class="external-link">Modifica questa pagina <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Tempo stimato: <i aria-hidden="true" data-feather="clock"></i> 50 minuti</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Espandi Tutte le Soluzioni " data-collapse="Nascondi Tutte le Soluzioni "> Espandi Tutte le Soluzioni <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Panoramica</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Domande</h3>
<ul><li>“Come si esegue un’applicazione MPI tramite Snakemake sul
cluster?”</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Obiettivi</h3>
<ul><li>“Definire le regole da eseguire localmente e sul cluster”</li>
</ul></div>
</div>
</div>
</div>
</div>
<p>Ora è il momento di tornare al nostro flusso di lavoro reale.
Possiamo eseguire un comando sul cluster, ma che dire dell’esecuzione
dell’applicazione MPI che ci interessa? La nostra applicazione si chiama
<code>amdahl</code> ed è disponibile come modulo d’ambiente.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Sfida</span>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Individuare e caricare il modulo <code>amdahl</code> e quindi
<em>sostituire</em> la nostra regola <code>hostname_remote</code> con
una versione che esegue <code>amdahl</code>. (Non preoccupatevi ancora
dell’MPI parallelo, ma eseguitelo con una sola CPU,
<code>mpiexec -n 1 amdahl</code>).</p>
<p>La regola viene eseguita correttamente? In caso contrario, cercare
nei file di log per scoprirne il motivo?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Mostrami la soluzione </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">module</span> spider amdahl</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">module</span> load amdahl</span></code></pre>
</div>
<p>individuerà e caricherà il modulo <code>amdahl</code>. Possiamo
quindi aggiornare/sostituire la nostra regola per eseguire
l’applicazione <code>amdahl</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Tuttavia, quando si tenta di eseguire la regola si ottiene un errore
(a meno che non sia già disponibile una versione diversa di
<code>amdahl</code> nel proprio percorso). Snakemake riporta la
posizione dei log e se guardiamo all’interno possiamo (alla fine)
trovare</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>...
mpiexec -n 1 amdahl &gt; amdahl_run.txt
--------------------------------------------------------------------------
mpiexec was unable to find the specified executable file, and therefore
did not launch the job.  This error was first reported for process
rank 0; it may have occurred for other processes as well.

NOTE: A common cause for this error is misspelling a mpiexec command
      line parameter option (remember that mpiexec interprets the first
      unrecognized command line token as the executable).

Node:       tmpnode1
Executable: amdahl
--------------------------------------------------------------------------
...</code></pre>
</div>
<p>Quindi, anche se abbiamo caricato il modulo prima di eseguire il
flusso di lavoro, la nostra regola Snakemake non ha trovato
l’eseguibile. Questo perché la regola Snakemake viene eseguita in un
ambiente <em>runtime</em> pulito e dobbiamo dirgli in qualche modo di
caricare il modulo ambiente necessario prima di provare a eseguire la
regola.</p>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="snakemake-e-moduli-di-ambiente">Snakemake e moduli di ambiente<a class="anchor" aria-label="anchor" href="#snakemake-e-moduli-di-ambiente"></a></h2>
<hr class="half-width"><p>La nostra applicazione si chiama <code>amdahl</code> ed è disponibile
sul sistema tramite un modulo d’ambiente, quindi dobbiamo dire a
Snakemake di caricare il modulo prima di provare a eseguire la regola.
Snakemake conosce i moduli d’ambiente, che possono essere specificati
tramite (un’altra) opzione:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>      <span class="co">"mpi4py"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    shell:</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>L’aggiunta di queste righe non è tuttavia sufficiente a far eseguire
la regola. Non solo bisogna dire a Snakemake quali moduli caricare, ma
bisogna anche dirgli di usare i moduli d’ambiente in generale (poiché si
ritiene che l’uso dei moduli d’ambiente renda l’ambiente di runtime meno
riproducibile, dato che i moduli disponibili possono differire da
cluster a cluster). Per questo è necessario dare a Snakemake un’opzione
aggiuntiva</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile <span class="at">--use-envmodules</span> amdahl_run</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Sfida</span>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Utilizzeremo i moduli d’ambiente per tutto il resto del tutorial,
quindi rendiamola un’opzione predefinita del nostro profilo (impostando
il suo valore a <code>True</code>)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Mostrami la soluzione </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Aggiornare il profilo del cluster a</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">use-envmodules</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre>
</div>
<p>Se si vuole testare, è necessario cancellare il file di output della
regola e rieseguire Snakemake.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-e-mpi">Snakemake e MPI<a class="anchor" aria-label="anchor" href="#snakemake-e-mpi"></a></h2>
<hr class="half-width"><p>Nell’ultima sezione non abbiamo eseguito un’applicazione MPI, in
quanto abbiamo eseguito solo su un core. Come si fa a richiedere
l’esecuzione su più core per una singola regola?</p>
<p>Snakemake ha un supporto generale per MPI, ma l’unico esecutore che
attualmente supporta esplicitamente MPI è l’esecutore Slurm (per nostra
fortuna!). Se guardiamo alla nostra tabella di traduzione da Slurm a
Snakemake, notiamo che le opzioni rilevanti appaiono in fondo:</p>
<table class="table"><colgroup><col width="18%"><col width="15%"><col width="65%"></colgroup><thead><tr class="header"><th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td>…</td>
<td>…</td>
<td>…</td>
</tr><tr class="even"><td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr><tr class="odd"><td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr><tr class="even"><td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr></tbody></table><p>L’opzione che ci interessa è <code>tasks</code>, poiché aumenteremo
solo il numero di ranghi. Possiamo definirli in una sezione
<code>resources</code> della nostra regola e fare riferimento ad essi
usando dei segnaposto:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    resources:</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">'mpiexec'</span>,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    shell:</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Questo ha funzionato, ma ora abbiamo un piccolo problema. Vogliamo
farlo per alcuni valori diversi di <code>tasks</code>, il che significa
che abbiamo bisogno di un file di output diverso per ogni esecuzione.
Sarebbe fantastico se potessimo indicare in qualche modo nel file
<code>output</code> il valore che vogliamo usare per <code>tasks</code>…
e far sì che Snakemake lo prenda.</p>
<p>Potremmo usare un <em>wildcard</em> nel <code>output</code> per
permetterci di definire il <code>tasks</code> che vogliamo usare. La
sintassi di questo carattere jolly è la seguente</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span></code></pre>
</div>
<p>dove <code>parallel_tasks</code> è il nostro carattere jolly.</p>
<div id="caratteri-jolly" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Richiamo</span>
<div id="caratteri-jolly" class="callout-inner">
<h3 class="callout-title">Caratteri jolly</h3>
<div class="callout-content">
<p>I caratteri jolly sono usati nelle righe <code>input</code> e
<code>output</code> della regola per rappresentare parti di nomi di
file. Come lo schema <code>*</code> nella shell, il carattere jolly può
sostituire qualsiasi testo per comporre il nome del file desiderato.
Come per la denominazione delle regole, si può scegliere un nome a
piacere per i caratteri jolly, qui abbiamo usato
<code>parallel_tasks</code>. L’uso degli stessi caratteri jolly
nell’input e nell’output indica a Snakemake come abbinare i file di
input a quelli di output.</p>
<p>Se due regole utilizzano un carattere jolly con lo stesso nome,
Snakemake le tratterà come entità diverse - le regole in Snakemake sono
autocontenute in questo modo.</p>
<p>Nella riga <code>shell</code> si può fare riferimento al carattere
jolly con <code>{wildcards.parallel_tasks}</code></p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="ordine-delle-operazioni-di-snakemake">Ordine delle operazioni di Snakemake<a class="anchor" aria-label="anchor" href="#ordine-delle-operazioni-di-snakemake"></a></h2>
<hr class="half-width"><p>Abbiamo appena iniziato con alcune semplici regole, ma vale la pena
di pensare a cosa fa esattamente Snakemake quando lo si esegue. Ci sono
tre fasi distinte:</p>
<ol style="list-style-type: decimal"><li>Prepara l’esecuzione:
<ol style="list-style-type: decimal"><li>Legge tutte le definizioni delle regole dal file Snakefile</li>
</ol></li>
<li>Pianifica cosa fare:
<ol style="list-style-type: decimal"><li>vede quale/i file si sta chiedendo di creare</li>
<li>Cerca una regola corrispondente guardando le <code>output</code> di
tutte le regole che conosce</li>
<li>Compila i caratteri jolly per ottenere il valore <code>input</code>
per questa regola</li>
<li>verifica che questo file di input (se richiesto) sia effettivamente
disponibile</li>
</ol></li>
<li>Esegue i passi:
<ol style="list-style-type: decimal"><li>Crea la directory per il file di output, se necessario</li>
<li>Rimuove il vecchio file di output, se è già presente</li>
<li>Solo allora, esegue il comando di shell con i segnaposto
sostituiti</li>
<li>controlla che il comando sia stato eseguito senza errori <em>e</em>
che il nuovo file di output sia stato creato come previsto</li>
</ol></li>
</ol><div id="modalità-di-esecuzione-a-secco--n" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Richiamo</span>
<div id="modalità-di-esecuzione-a-secco--n" class="callout-inner">
<h3 class="callout-title">Modalità di esecuzione a secco
(<code>-n</code>)</h3>
<div class="callout-content">
<p>Spesso è utile eseguire solo le prime due fasi, in modo che Snakemake
pianifichi i lavori da eseguire e li stampi sullo schermo, ma non li
esegua mai. Questo viene fatto con il flag <code>-n</code>, ad
esempio:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="op">&gt;</span> $ <span class="ex">snakemake</span> <span class="at">-n</span> ...</span></code></pre>
</div>
</div>
</div>
</div>
<p>La quantità di controlli può sembrare pedante in questo momento, ma
con l’aumentare dei passi del flusso di lavoro questo diventerà davvero
molto utile.</p>
</section><section><h2 class="section-heading" id="usando-i-caratteri-jolly-nella-nostra-regola">Usando i caratteri jolly nella nostra regola<a class="anchor" aria-label="anchor" href="#usando-i-caratteri-jolly-nella-nostra-regola"></a></h2>
<hr class="half-width"><p>Vorremmo usare un carattere jolly nel <code>output</code> per
permetterci di definire il numero di <code>tasks</code> che vogliamo
usare. Sulla base di quanto visto finora, si potrebbe immaginare che
questo potrebbe essere simile a</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    resources:</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="st">"</span><span class="sc">{parallel_tasks}</span><span class="st">"</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    shell:</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>ma ci sono due problemi:</p>
<ul><li>L’unico modo per Snakemake di conoscere il valore del carattere
jolly è che l’utente richieda esplicitamente un file di output concreto
(invece di chiamare la regola):</li>
</ul><div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>  <span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile amdahl_run_2.txt</span></code></pre>
</div>
<p>questo è perfettamente valido, poiché Snakemake è in grado di capire
che ha una regola che può corrispondere a quel nome di file.</p>
<ul><li>
<p>Il problema maggiore è che anche così non funziona, sembra che
non si possa usare un carattere jolly per <code>tasks</code>:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>WorkflowError:
SLURM job submission failed. The error message was sbatch:
error: Invalid numeric value "{parallel_tasks}" for --ntasks.</code></pre>
</div>
</li>
</ul><p>Purtroppo per noi, non c’è un modo diretto per accedere ai caratteri
jolly per <code>tasks</code>. Il motivo è che Snakemake cerca di usare
il valore di <code>tasks</code> durante la fase di inizializzazione,
quindi prima di conoscere il valore del carattere jolly. È necessario
rimandare la determinazione di <code>tasks</code> a un momento
successivo. Questo si può ottenere specificando una funzione di input
invece di un valore per questo scenario. La soluzione è quindi quella di
scrivere una funzione da usare una sola volta per manipolare Snakemake
in modo che lo faccia per noi. Poiché la funzione è specifica per la
regola, possiamo usare una funzione di una riga senza nome. Questo tipo
di funzioni sono chiamate funzioni anonime o funzioni lamdba (entrambe
hanno lo stesso significato) e sono una caratteristica di Python (e di
altri linguaggi di programmazione).</p>
<p>Per definire una funzione lambda in python, la sintassi generale è la
seguente:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">lambda</span> x: x <span class="op">+</span> <span class="dv">54</span></span></code></pre>
</div>
<p>Poiché la nostra funzione può accettare i caratteri jolly come
argomenti, possiamo usarli per impostare il valore di
<code>tasks</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    resources:</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    shell:</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Ora abbiamo una regola che può essere usata per generare output da
esecuzioni di un numero arbitrario di task paralleli.</p>
<div id="commenti-in-snakefiles" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Richiamo</span>
<div id="commenti-in-snakefiles" class="callout-inner">
<h3 class="callout-title">Commenti in Snakefiles</h3>
<div class="callout-content">
<p>Nel codice precedente, la riga che inizia con <code>#</code> è una
riga di commento. Si spera che abbiate già l’abitudine di aggiungere
commenti ai vostri script. Un buon commento rende qualsiasi script più
leggibile, e questo vale anche per Snakefiles.</p>
</div>
</div>
</div>
<p>Poiché la nostra regola è ora in grado di generare un numero
arbitrario di file di output, le cose potrebbero diventare molto
affollate nella nostra directory corrente. Probabilmente è meglio
mettere le esecuzioni in una cartella separata per mantenere l’ordine.
Possiamo aggiungere la cartella direttamente al nostro
<code>output</code> e Snakemake si occuperà della creazione della
directory per noi:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    resources:</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    shell:</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Sfida</span>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Creare un file di output (sotto la cartella <code>runs</code>) per il
caso in cui si abbiano 6 task paralleli</p>
<p>(SUGGERIMENTO: ricordate che Snakemake deve essere in grado di far
corrispondere il file richiesto al <code>output</code> di una
regola)</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Mostrami la soluzione </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile runs/amdahl_run_6.txt</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Un’altra cosa della nostra applicazione <code>amdahl</code> è che
alla fine vogliamo elaborare l’output per generare il nostro grafico in
scala. L’output in questo momento è utile per la lettura, ma rende più
difficile l’elaborazione. in <code>amdahl</code> c’è un’opzione che ci
facilita questo compito. Per vedere le opzioni di <code>amdahl</code> si
può usare</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load amdahl</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ amdahl <span class="at">--help</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: amdahl [-h] [-p [PARALLEL_PROPORTION]] [-w [WORK_SECONDS]] [-t] [-e]

options:
  -h, --help            show this help message and exit
  -p [PARALLEL_PROPORTION], --parallel-proportion [PARALLEL_PROPORTION]
                        Parallel proportion should be a float between 0 and 1
  -w [WORK_SECONDS], --work-seconds [WORK_SECONDS]
                        Total seconds of workload, should be an integer greater than 0
  -t, --terse           Enable terse output
  -e, --exact           Disable random jitter</code></pre>
</div>
<p>L’opzione che stiamo cercando è <code>--terse</code>, che farà
stampare l’output di <code>amdahl</code> in un formato molto più facile
da elaborare, JSON. Il formato JSON in un file usa tipicamente
l’estensione <code>.json</code>, quindi aggiungiamo questa opzione al
nostro comando <code>shell</code> e cambiamo il formato del file
<code>output</code> per adattarlo al nostro nuovo comando:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    resources:</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    shell:</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse &gt; {output}"</span></span></code></pre>
</div>
<p>C’era un altro parametro per <code>amdahl</code> che ha attirato la
mia attenzione. <code>amdahl</code> ha un’opzione
<code>--parallel-proportion</code> (o <code>-p</code>) che potremmo
essere interessati a cambiare perché modifica il comportamento del
codice e quindi ha un impatto sui valori che otteniamo nei nostri
risultati. Aggiungiamo un altro livello di directory al nostro formato
di output per riflettere una scelta particolare per questo valore.
Possiamo usare un carattere jolly in modo da non dover scegliere subito
il valore:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    resources:</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    shell:</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse -p {wildcards.parallel_proportion} &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Sfida</span>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Crea un file di output per un valore di <code>-p</code> di 0,999 (il
valore predefinito è 0,8) per il caso in cui abbiamo 6 task
paralleli.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Mostrami la soluzione </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Punti Chiave</span>
<div class="callout-inner">
<div class="callout-content">
<ul><li>“Snakemake sceglie la regola appropriata sostituendo i caratteri
jolly in modo che l’output corrisponda all’obiettivo”</li>
<li>“Snakemake controlla varie condizioni di errore e si ferma se vede
un problema”</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Capitolo Precedente e Successivo"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/03-placeholders.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Precedente</a>
        <a class="chapter-link float-end" href="../instructor/05-chaining_rules.html">Successivo<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/03-placeholders.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Precedente: Segnaposto
        </a>
        <a class="chapter-link float-end" href="../instructor/05-chaining_rules.html" rel="next">
          Successivo: Concatenazione di...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>Questa lezione è soggetta al <a href="CODE_OF_CONDUCT.html">Codice di Condotta</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-snakemake_and_mpi.md" class="external-link">Modifica su GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CONTRIBUTING.md" class="external-link">Contributi</a>
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/" class="external-link">Fonte</a></p>
				<p><a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CITATION.cff" class="external-link">Cita</a> | <a href="mailto:maintainers-hpc@lists.carpentries.org">Contatti</a> | <a href="https://carpentries.org/about/" class="external-link">Informazioni</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY-4.0</a> by the authors</p>

        <p>Template concesso in licenza sotto <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> da <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Realizzato con <a href="https://github.com/carpentries/sandpaper/tree/0.17.1" class="external-link">sandpaper (0.17.1)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a> e <a href="https://github.com/carpentries/varnish/tree/1.0.7" class="external-link">varnish (1.0.7)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Torna all'inizio"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Indietro</span> Torna all'inizio
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://carpentries-incubator.github.io/hpc-workflows/instructor/04-snakemake_and_mpi.html",
  "inLanguage": "it",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "HPC Carpentry, snakemake, workflows, hpc",
  "name": "Applicazioni MPI e Snakemake",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/hpc-workflows/instructor/04-snakemake_and_mpi.html",
  "identifier": "https://carpentries-incubator.github.io/hpc-workflows/instructor/04-snakemake_and_mpi.html",
  "dateCreated": "2023-04-19",
  "dateModified": "2025-04-05",
  "datePublished": "2025-11-07"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo --><script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
          _paq.push(["setDoNotTrack", true]);
          _paq.push(["disableCookies"]);
          _paq.push(["trackPageView"]);
          _paq.push(["enableLinkTracking"]);
          (function() {
              var u="https://matomo.carpentries.org/";
              _paq.push(["setTrackerUrl", u+"matomo.php"]);
              _paq.push(["setSiteId", "1"]);
              var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0];
              g.async=true; g.src="https://matomo.carpentries.org/matomo.js"; s.parentNode.insertBefore(g,s);
          })();
        </script><!-- End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

